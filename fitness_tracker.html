<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é¥®é£Ÿè®­ç»ƒè¿½è¸ªåŠ©æ‰‹ - æ‹ç…§ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs (Compatibility Mode) -->
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { background-color: #f8fafc; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; }
        .card { background: white; border-radius: 1rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        #loadingOverlay { position: fixed; inset: 0; background: rgba(255,255,255,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #6366f1; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .modal-bg { position: fixed; inset: 0; z-index: 50; display: none; align-items: center; justify-content: center; backdrop-blur-sm; background: rgba(0,0,0,0.4); }
        .photo-preview { width: 100%; height: 200px; object-fit: cover; border-radius: 0.75rem; background: #f1f5f9; cursor: pointer; transition: filter 0.2s; }
        .photo-preview:hover { filter: brightness(0.9); }
        .photo-upload-box { height: 200px; border-radius: 0.75rem; cursor: pointer; transition: all 0.2s; }
        .photo-upload-box:hover { border-color: #6366f1; background-color: #f5f7ff; }
    </style>
</head>
<body class="p-4 md:p-8">
    <!-- å…¨å±€åŠ è½½é®ç½© -->
    <div id="loadingOverlay">
        <div class="spinner mb-4"></div>
        <p id="loadingText" class="text-gray-500 font-medium">æ­£åœ¨è¿æ¥æœåŠ¡å™¨...</p>
    </div>

    <div class="max-w-5xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 class="text-3xl font-bold text-gray-800 text-indigo-600">ğŸ å¥èº«è¿½è¸ªPro</h1>
                <div class="flex items-center gap-2 mt-2">
                    <input type="date" id="datePicker" onchange="handleDateChange()" class="bg-indigo-50 text-indigo-700 font-medium px-3 py-1 rounded-lg border-none focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                    <span id="syncStatus" class="text-[10px] bg-gray-100 text-gray-400 px-2 py-1 rounded-md">æ£€æŸ¥è¿æ¥ä¸­...</span>
                </div>
            </div>
            <div class="flex items-center gap-3">
                <div id="userDisplay" class="hidden text-right">
                    <p class="text-xs text-gray-400">å½“å‰è´¦æˆ·</p>
                    <p id="userEmail" class="text-sm font-medium text-gray-700"></p>
                </div>
                <button id="loginBtn" onclick="openAuthModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition text-sm font-medium">ç™»å½•/æ³¨å†Œ</button>
                <button id="logoutBtn" onclick="handleLogout()" class="hidden bg-gray-100 hover:bg-gray-200 text-gray-600 px-4 py-2 rounded-lg transition text-sm">é€€å‡º</button>
                <button onclick="toggleSettings()" class="bg-gray-800 hover:bg-gray-900 text-white px-4 py-2 rounded-lg transition text-sm">âš™ï¸ è®¾ç½®</button>
            </div>
        </header>

        <!-- ä¸»å†…å®¹åŒº -->
        <div id="mainContent" class="opacity-50 pointer-events-none transition-opacity duration-500">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 space-y-6">
                    <!-- ä»»åŠ¡æ ¸å¯¹ -->
                    <div class="card p-6 border-t-4 border-indigo-500">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span>ğŸ“… ä»»åŠ¡æ ¸å¯¹</span>
                                <span id="dayScore" class="text-xs px-2 py-1 rounded-full text-center font-bold">--</span>
                            </div>
                            <span id="selectedDateLabel" class="text-sm font-normal text-gray-400"></span>
                        </h2>
                        <div id="dynamicChecklist" class="space-y-6"></div>
                        <button onclick="saveToCloud()" class="mt-8 w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 rounded-xl shadow-lg transition-all active:scale-95">
                            ä¿å­˜åŒæ­¥æ•°æ®
                        </button>
                    </div>

                    <!-- ä½“é‡ä¸ç…§ç‰‡è®°å½• -->
                    <div class="card p-6">
                        <h2 class="text-xl font-semibold text-gray-700 mb-4 flex items-center gap-2">
                            <span>ğŸ“ˆ ä½“é‡ä¸ä½“å‹è®°å½•</span>
                            <span class="text-[10px] bg-emerald-100 text-emerald-600 px-2 py-0.5 rounded font-bold uppercase">ç‚¹å‡»é¢„è§ˆå›¾ä¸Šä¼ ç…§ç‰‡</span>
                        </h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
                            <div class="flex flex-col justify-center space-y-4">
                                <div>
                                    <label class="block text-xs font-bold text-gray-400 mb-1">ä»Šæ—¥ä½“é‡ (kg)</label>
                                    <input type="number" id="weightInput" step="0.1" placeholder="ä¾‹å¦‚: 70.5" class="w-full border border-gray-200 rounded-lg px-4 py-3 text-lg font-bold outline-none focus:border-indigo-500">
                                </div>
                                <button onclick="addWeightAndPhoto()" class="w-full bg-emerald-500 hover:bg-emerald-600 text-white px-6 py-3 rounded-xl transition font-bold shadow-md shadow-emerald-100">ç¡®è®¤è®°å½•</button>
                                <p class="text-[10px] text-gray-400 text-center">ç‚¹å‡»å³ä¾§æ–¹å—å¯ä»¥æ‹æ‘„æˆ–ä¸Šä¼ ä½“å‹ç…§ç‰‡</p>
                            </div>
                            <div class="relative group">
                                <input type="file" id="fileInput" accept="image/*" class="hidden" onchange="handleFileUpload(event)">
                                <div id="photoContainer" onclick="document.getElementById('fileInput').click()" class="photo-upload-box bg-gray-50 flex flex-col items-center justify-center border-2 border-dashed border-gray-200">
                                    <img id="todayPhotoPreview" src="" alt="ä½“å‹é¢„è§ˆ" class="photo-preview hidden">
                                    <div id="photoPlaceholder" class="text-gray-400 flex flex-col items-center">
                                        <div class="p-4 bg-white rounded-full shadow-sm mb-3">
                                            <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                                        </div>
                                        <p class="text-sm font-medium">ç‚¹å‡»æ‹æ‘„/ä¸Šä¼ ç…§ç‰‡</p>
                                        <p class="text-[10px] mt-1">(å¯é€‰)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="h-64"><canvas id="weightChart"></canvas></div>
                    </div>
                </div>

                <!-- ä¾§è¾¹æ  -->
                <div class="space-y-6">
                    <!-- ç»Ÿè®¡é¢æ¿ -->
                    <div class="card p-6 bg-gradient-to-br from-indigo-600 to-blue-700 text-white shadow-xl shadow-indigo-100">
                        <h3 class="font-bold opacity-80 mb-4 uppercase tracking-wider text-sm">æ¦‚è§ˆç»Ÿè®¡</h3>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-3xl font-black" id="statCompletion">0%</p>
                                <p class="text-xs opacity-70">ä»»åŠ¡å®Œæˆç‡</p>
                            </div>
                            <div>
                                <p class="text-3xl font-black" id="statWeightChange">--</p>
                                <p class="text-xs opacity-70">ä½“é‡å˜åŒ–</p>
                            </div>
                        </div>
                    </div>

                    <!-- ä½“å‹ç›¸å†Œ (æœ€è¿‘) -->
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-4 flex justify-between items-center">
                            <span>ğŸ–¼ï¸ ä½“å‹å¿«ç…§</span>
                            <span class="text-[10px] text-gray-400">æœ€è¿‘ 3 æ¬¡</span>
                        </h3>
                        <div id="photoGallery" class="grid grid-cols-1 gap-4">
                            <p class="text-center text-gray-300 text-xs py-4">æš‚æ— ç…§ç‰‡è®°å½•</p>
                        </div>
                    </div>

                    <!-- å†å²è®°å½•åˆ—è¡¨ -->
                    <div class="card p-6">
                        <h3 class="font-bold text-gray-700 mb-4">æœ€è¿‘è®°å½•</h3>
                        <div id="historyLogs" class="space-y-3 max-h-80 overflow-y-auto custom-scrollbar pr-2 text-sm"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- è´¦æˆ·æ¨¡æ€æ¡† -->
    <div id="authModal" class="modal-bg">
        <div class="card w-full max-w-sm p-8 m-4">
            <h2 class="text-2xl font-bold text-gray-800 mb-2">è´¦æˆ·ç®¡ç†</h2>
            <p class="text-gray-400 text-sm mb-6">åŒæ­¥æ‚¨çš„å¥èº«æ•°æ®</p>
            <div class="space-y-4">
                <div class="p-3 bg-indigo-50 border border-indigo-100 rounded-lg text-indigo-700 text-[10px]">
                    å¼€å¯åŒæ­¥åï¼Œæ‚¨å¯ä»¥ä»ä»»ä½•è®¾å¤‡è®¿é—®ç…§ç‰‡å’Œè®°å½•ã€‚
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">é‚®ç®±åœ°å€</label>
                    <input type="email" id="authEmail" placeholder="example@mail.com" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-400 mb-1">å¯†ç  (è‡³å°‘6ä½)</label>
                    <input type="password" id="authPass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢" class="w-full p-3 bg-gray-50 border border-gray-100 rounded-xl outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div id="authErrorMessage" class="text-red-500 text-xs hidden"></div>
                <div class="flex gap-2 pt-2">
                    <button onclick="handleAuth('login')" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold hover:bg-indigo-700 transition">ç™»å½•</button>
                    <button onclick="handleAuth('register')" class="flex-1 border border-indigo-600 text-indigo-600 py-3 rounded-xl font-bold hover:bg-indigo-50 transition">æ³¨å†Œ</button>
                </div>
                <button onclick="closeAuthModal()" class="w-full text-gray-400 text-sm py-2">ç¨åå†è¯´</button>
            </div>
        </div>
    </div>

    <!-- é…ç½®æ¨¡æ€æ¡† -->
    <div id="settingsModal" class="modal-bg">
        <div class="card w-full max-w-lg p-6 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">å®šåˆ¶è®¡åˆ’</h2>
                <button onclick="toggleSettings()" class="text-gray-400 hover:text-gray-600">âœ•</button>
            </div>
            <div id="dietSettingsList" class="space-y-2 mb-6"></div>
            <div id="workoutSettingsList" class="space-y-2 mb-6"></div>
            <button onclick="toggleSettings()" class="w-full bg-indigo-600 text-white py-4 rounded-xl font-bold shadow-lg shadow-indigo-100">å®Œæˆè®¾ç½®</button>
        </div>
    </div>

    <div id="toast" class="fixed bottom-10 left-1/2 transform -translate-x-1/2 bg-gray-900 text-white px-8 py-3 rounded-full opacity-0 transition-all duration-300 pointer-events-none z-50"></div>

    <script>
        const firebaseConfig = JSON.parse(__firebase_config);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'fitness-pro-photo-v1';

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        let currentUser = null;
        let selectedDate = new Date().toISOString().split('T')[0];
        let currentPhotoBase64 = null;
        let unsubscribeData = null;
        
        let appData = {
            config: {
                diet: [
                    "æ—©é¤ï¼š2ä¸ªå…¨è›‹ + 1ä¸ªè›‹ç™½ + 50gç‡•éº¦ç‰‡ + 200mlæ— ç³–è±†æµ†/è„±è„‚å¥¶", 
                    "åˆé¤ï¼š150gé¸¡èƒ¸è‚‰/ç˜¦ç‰›è‚‰ + 150gç³™ç±³é¥­ + 250gç»¿å¶è”¬èœï¼ˆå°‘æ²¹ï¼‰", 
                    "åŠ é¤ï¼šä¸€ä¸ªè‹¹æœ / 20gåŸå‘³åšæœ / ä¸€ä»½ä¹³æ¸…è›‹ç™½ç²‰", 
                    "æ™šé¤ï¼š150gæ¸…è’¸é±¼/è™¾ä» + ä¸€ä»½å¤§æ‹Œèœï¼ˆé†‹æ±ï¼‰+ åŠä¸ªç´«è–¯ï¼ˆçº¦80gï¼‰",
                    "æ¯æ—¥ 2L æ°´",
                    "ç¡çœ è´¨é‡æ˜¯å¦è¾¾æ ‡"
                ],
                workout: ["æ¯æ—¥æ­¥æ•° > 8000", "è®­ç»ƒ 30-60 åˆ†é’Ÿ"]
            },
            dailyLogs: {},
            weightLogs: [] 
        };

        let weightChart = null;

        function openAuthModal() { 
            document.getElementById('authErrorMessage').classList.add('hidden');
            document.getElementById('authModal').style.display = 'flex'; 
        }
        function closeAuthModal() { document.getElementById('authModal').style.display = 'none'; }

        async function handleAuth(type) {
            const email = document.getElementById('authEmail').value.trim();
            const pass = document.getElementById('authPass').value;
            const errorEl = document.getElementById('authErrorMessage');
            
            if (!email || pass.length < 6) {
                errorEl.innerText = "è¯·è¾“å…¥æœ‰æ•ˆé‚®ç®±å’Œè‡³å°‘6ä½å¯†ç ";
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                errorEl.classList.add('hidden');
                document.getElementById('loadingOverlay').style.display = 'flex';
                if (type === 'register') await auth.createUserWithEmailAndPassword(email, pass);
                else await auth.signInWithEmailAndPassword(email, pass);
                closeAuthModal();
            } catch (err) {
                document.getElementById('loadingOverlay').style.display = 'none';
                errorEl.innerText = err.message;
                errorEl.classList.remove('hidden');
            }
        }

        async function handleLogout() {
            if (unsubscribeData) unsubscribeData();
            await auth.signOut();
            window.location.reload();
        }

        auth.onAuthStateChanged(async user => {
            const loadingOverlay = document.getElementById('loadingOverlay');
            const mainContent = document.getElementById('mainContent');
            const loginBtn = document.getElementById('loginBtn');
            const logoutBtn = document.getElementById('logoutBtn');
            const userDisplay = document.getElementById('userDisplay');
            const userEmailText = document.getElementById('userEmail');

            if (user) {
                currentUser = user;
                loginBtn.classList.add('hidden');
                logoutBtn.classList.remove('hidden');
                userDisplay.classList.remove('hidden');
                userEmailText.innerText = user.isAnonymous ? "åŒ¿åè®¿å®¢" : user.email;
                mainContent.style.opacity = '1';
                mainContent.style.pointerEvents = 'auto';
                loadUserData();
            } else {
                try {
                    await auth.signInAnonymously();
                } catch (e) {
                    loadingOverlay.style.display = 'none';
                    openAuthModal();
                }
            }
        });

        function loadUserData() {
            if (!currentUser) return;
            const docRef = db.doc(`artifacts/${appId}/users/${currentUser.uid}/settings/main`);
            if (unsubscribeData) unsubscribeData();
            
            unsubscribeData = docRef.onSnapshot(doc => {
                if (doc.exists) {
                    const data = doc.data();
                    appData = {
                        ...appData,
                        ...data,
                        config: { ...appData.config, ...(data.config || {}) }
                    };
                    appData.weightLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
                    updateUI();
                } else {
                    saveToCloud(); 
                }
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('syncStatus').innerText = "äº‘ç«¯åŒæ­¥ä¸­";
            }, err => {
                showToast("è¿æ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°");
            });
        }

        async function saveToCloud() {
            if (!currentUser) return;
            const docRef = db.doc(`artifacts/${appId}/users/${currentUser.uid}/settings/main`);
            try {
                await docRef.set(appData);
                document.getElementById('syncStatus').innerText = "å·²åŒæ­¥";
                showToast("åŒæ­¥æˆåŠŸ");
            } catch (err) {
                showToast("ä¿å­˜å¤±è´¥");
            }
        }

        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            if (file.size > 1024 * 1024) {
                showToast("å›¾ç‰‡å¤ªå¤§ï¼ˆè¯·å°äº 1MBï¼‰");
                return;
            }
            const reader = new FileReader();
            reader.onload = (e) => {
                currentPhotoBase64 = e.target.result;
                displayCurrentPhoto();
            };
            reader.readAsDataURL(file);
        }

        function displayCurrentPhoto() {
            const img = document.getElementById('todayPhotoPreview');
            const placeholder = document.getElementById('photoPlaceholder');
            if (currentPhotoBase64) {
                img.src = currentPhotoBase64;
                img.classList.remove('hidden');
                placeholder.classList.add('hidden');
            } else {
                img.classList.add('hidden');
                placeholder.classList.remove('hidden');
            }
        }

        function updateUI() {
            renderChecklist();
            renderHistory();
            renderSettings();
            renderGallery();
            updateStats();
            const weightEntry = appData.weightLogs.find(l => l.date === selectedDate);
            document.getElementById('weightInput').value = weightEntry ? weightEntry.value : '';
            currentPhotoBase64 = weightEntry ? weightEntry.photo : null;
            displayCurrentPhoto();
            if (weightChart) updateChart(); else initChart();
            document.getElementById('selectedDateLabel').innerText = selectedDate;
        }

        function handleDateChange() {
            selectedDate = document.getElementById('datePicker').value;
            updateUI();
        }

        function addWeightAndPhoto() {
            const weight = parseFloat(document.getElementById('weightInput').value);
            if (isNaN(weight)) {
                showToast("è¯·è¾“å…¥æœ‰æ•ˆä½“é‡");
                return;
            }
            appData.weightLogs = appData.weightLogs.filter(l => l.date !== selectedDate);
            appData.weightLogs.push({ 
                date: selectedDate, 
                value: weight, 
                photo: currentPhotoBase64 
            });
            appData.weightLogs.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveToCloud();
        }

        function renderGallery() {
            const container = document.getElementById('photoGallery');
            const photosWithDate = appData.weightLogs
                .filter(l => l.photo)
                .slice(-3)
                .reverse();
            if (photosWithDate.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-300 text-xs py-4">æš‚æ— ç…§ç‰‡è®°å½•</p>';
                return;
            }
            container.innerHTML = photosWithDate.map(p => `
                <div class="relative group cursor-pointer overflow-hidden rounded-xl border border-gray-100 shadow-sm" onclick="jumpToDate('${p.date}')">
                    <img src="${p.photo}" class="w-full h-32 object-cover transition duration-300 group-hover:scale-105">
                    <div class="absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/70 to-transparent text-white p-2 text-[10px] flex justify-between">
                        <span class="font-bold">${p.date}</span>
                        <span>${p.value} kg</span>
                    </div>
                </div>
            `).join('');
        }

        function renderChecklist() {
            const container = document.getElementById('dynamicChecklist');
            const log = appData.dailyLogs[selectedDate] || { diet: {}, workout: {} };
            let html = '<div class="space-y-6">';
            [{ title: 'ğŸ¥— è¥å…»æ‘„å…¥', key: 'diet' }, { title: 'ğŸ’ª è¿åŠ¨è¡¨ç°', key: 'workout' }].forEach(sec => {
                html += `<div><h3 class="text-xs font-bold text-gray-400 mb-3 uppercase tracking-widest">${sec.title}</h3><div class="space-y-2">`;
                appData.config[sec.key].forEach(item => {
                    const checked = (log[sec.key] && log[sec.key][item]) ? 'checked' : '';
                    html += `<label class="flex items-start justify-between p-4 bg-gray-50/50 border border-gray-100 rounded-xl cursor-pointer hover:bg-indigo-50 transition group">
                        <span class="text-sm text-gray-700 font-medium group-hover:text-indigo-600 leading-relaxed pr-4">${item}</span>
                        <input type="checkbox" onchange="toggleTask('${sec.key}', '${item}')" ${checked} class="w-6 h-6 mt-0.5 accent-indigo-600 rounded shrink-0">
                    </label>`;
                });
                html += `</div></div>`;
            });
            container.innerHTML = html;
            updateDayScore();
        }

        function toggleTask(type, item) {
            if (!appData.dailyLogs[selectedDate]) appData.dailyLogs[selectedDate] = { diet: {}, workout: {} };
            if (!appData.dailyLogs[selectedDate][type]) appData.dailyLogs[selectedDate][type] = {};
            appData.dailyLogs[selectedDate][type][item] = !appData.dailyLogs[selectedDate][type][item];
            updateDayScore();
        }

        function updateDayScore() {
            const log = appData.dailyLogs[selectedDate];
            const badge = document.getElementById('dayScore');
            if (!log) { 
                badge.innerText = "æœªå¼€å§‹"; 
                badge.className = "text-[10px] px-2 py-0.5 rounded-full bg-gray-100 text-gray-400";
                return; 
            }
            const total = appData.config.diet.length + appData.config.workout.length;
            const done = (Object.values(log.diet || {}).filter(v => v).length + Object.values(log.workout || {}).filter(v => v).length);
            badge.innerText = `å®Œæˆ ${done}/${total}`;
            if (done === total && total > 0) {
                badge.className = "text-[10px] px-2 py-0.5 rounded-full bg-emerald-500 text-white";
            } else {
                badge.className = "text-[10px] px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-600";
            }
        }

        function initChart() {
            const ctx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(ctx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'ä½“é‡', data: [], borderColor: '#6366f1', tension: 0.4, fill: true, backgroundColor: 'rgba(99,102,241,0.05)' }]},
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });
            updateChart();
        }

        function updateChart() {
            const recent = appData.weightLogs.slice(-7);
            weightChart.data.labels = recent.map(l => l.date.slice(5));
            weightChart.data.datasets[0].data = recent.map(l => l.value);
            weightChart.update();
        }

        function updateStats() {
            const logs = Object.keys(appData.dailyLogs);
            if (logs.length > 0) {
                let totalScore = 0;
                logs.forEach(date => {
                    const log = appData.dailyLogs[date];
                    const total = appData.config.diet.length + appData.config.workout.length;
                    const done = (Object.values(log.diet || {}).filter(v => v).length + Object.values(log.workout || {}).filter(v => v).length);
                    totalScore += (total > 0 ? done / total : 0);
                });
                document.getElementById('statCompletion').innerText = Math.round((totalScore / logs.length) * 100) + "%";
            }
            if (appData.weightLogs.length >= 2) {
                const diff = (appData.weightLogs[appData.weightLogs.length-1].value - appData.weightLogs[0].value).toFixed(1);
                document.getElementById('statWeightChange').innerText = (diff > 0 ? '+' : '') + diff + "kg";
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyLogs');
            const dates = Object.keys(appData.dailyLogs).sort().reverse().slice(0, 10);
            container.innerHTML = dates.map(d => `<div onclick="jumpToDate('${d}')" class="p-4 bg-gray-50 rounded-xl cursor-pointer hover:bg-indigo-50 transition flex justify-between items-center group text-xs">
                <div class="flex flex-col">
                    <span class="font-bold text-gray-700">${d}</span>
                    <span class="text-[10px] text-gray-400">ç‚¹å‡»å›é¡¾</span>
                </div>
                <div class="bg-white p-2 rounded-full shadow-sm group-hover:bg-indigo-600 group-hover:text-white transition">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </div>
            </div>`).join('') || '<p class="text-center text-gray-400 py-4">æš‚æ— å†å²</p>';
        }

        function jumpToDate(d) {
            selectedDate = d;
            document.getElementById('datePicker').value = d;
            updateUI();
        }

        function toggleSettings() {
            const modal = document.getElementById('settingsModal');
            const isHidden = modal.style.display === 'none' || modal.style.display === '';
            modal.style.display = isHidden ? 'flex' : 'none';
            if (!isHidden) saveToCloud();
        }

        function renderSettings() {
            [{k:'diet', n:'é¥®é£Ÿ'}, {k:'workout', n:'è®­ç»ƒ'}].forEach(t => {
                document.getElementById(`${t.k}SettingsList`).innerHTML = `
                    <h3 class="font-bold text-gray-400 mb-2 text-xs uppercase tracking-widest">é…ç½® ${t.n} è®¡åˆ’é¡¹</h3>
                    ${appData.config[t.k].map((item, i) => `<div class="flex justify-between items-center bg-gray-50 p-3 rounded-xl mb-1 text-sm font-medium"><span>${item}</span><button onclick="removeItem('${t.k}', ${i})" class="text-red-400 hover:text-red-600 p-1">âœ•</button></div>`).join('')}
                    <div class="flex gap-2 mt-2 mb-4"><input id="new${t.k}" placeholder="æ·»åŠ æ–°è®¡åˆ’..." class="flex-1 p-3 border border-gray-100 rounded-xl text-sm outline-none focus:border-indigo-500 bg-gray-50"><button onclick="addItem('${t.k}')" class="bg-indigo-600 text-white px-4 rounded-xl text-sm font-bold">æ·»åŠ </button></div>
                `;
            });
        }

        function addItem(type) {
            const input = document.getElementById(`new${type}`);
            if (input.value) { appData.config[type].push(input.value); input.value = ''; renderSettings(); }
        }

        function removeItem(type, i) { appData.config[type].splice(i, 1); renderSettings(); }

        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerText = m; t.style.opacity = "1";
            setTimeout(() => t.style.opacity = "0", 3000);
        }

        window.onload = () => { 
            document.getElementById('datePicker').value = selectedDate; 
        };
    </script>
</body>
</html>